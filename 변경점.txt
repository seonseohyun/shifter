================================================================================
시프트 스케줄러 v2.0 변경점 및 API 문서
================================================================================
작성일: 2025-01-06
버전: v2.0 (완전 개선판)
상태: 완료 ✅ 14/14 테스트 100% 통과

================================================================================
🎯 핵심 개선사항
================================================================================

1. 명시적 시프트 지정 시스템
   - custom_rules에서 night_shifts, off_shifts 직접 지정 가능
   - 키워드 매칭 오류 완전 해결 (Morning -> Night 오류 등)

2. 개선된 오류 분석 시스템
   - INFEASIBLE 원인 구체적 분석 제공
   - 용량 부족, 제약 충돌 등 명확한 진단
   - 해결 방안 자동 제시

3. 프로토콜 호환성
   - 클라이언트 필드 자동 변환 (job_category → position 등)
   - 기존 클라이언트 코드 수정 없이 사용 가능

4. 성능 최적화
   - 평균 처리 시간: 0.07초 (이전: 15-20초)
   - 안정적인 OR-Tools 제약조건 시스템

================================================================================
📡 클라이언트 → 서버 요청 프로토콜
================================================================================

### 기본 요청 형식
```json
{
  "staff_data": {
    "staff": [
      {
        "name": "김간호사",
        "staff_id": 1001,
        "grade": 3,
        "grade_name": "주임간호사",
        "position": "간호",
        "total_monthly_work_hours": 195
      },
      {
        "name": "이간호사",
        "staff_id": 1002,
        "grade": 4,
        "grade_name": "간호사",
        "position": "간호",
        "total_monthly_work_hours": 190
      },
      {
        "name": "박간호사",
        "staff_id": 1003,
        "grade": 5,
        "grade_name": "신규간호사",
        "position": "간호",
        "total_monthly_work_hours": 180
      }
    ]
  },
  "position": "간호",
  "target_month": "2025-09",
  "custom_rules": {
    "shifts": ["Day", "Evening", "Night", "Off"],
    "shift_hours": {
      "Day": 8,
      "Evening": 8,
      "Night": 8,
      "Off": 0
    },
    "night_shifts": ["Night"],
    "off_shifts": ["Off"]
  }
}
```

### 클라이언트 호환 형식 (자동 변환됨)
```json
{
  "staff_data": {
    "staff": [
      {
        "name": "김간호사",
        "staff_uid": 101,
        "grade": 3,
        "job_category": "간호",
        "monthly_workhour": 195
      }
    ]
  },
  "position": "간호",
  "target_month": "2025-09",
  "custom_rules": {
    "shifts": ["D", "E", "N", "O"],
    "shift_hours": {"D": 8, "E": 8, "N": 8, "O": 0}
  }
}
```

================================================================================
📤 서버 → 클라이언트 응답 프로토콜
================================================================================

### 성공 응답
```json
{
  "status": "ok",
  "schedule": {
    "2025-09-01": [
      {
        "shift": "Day",
        "hours": 8,
        "people": [
          {
            "이름": "김간호사",
            "직원번호": 1001,
            "등급": 3,
            "grade": 3
          }
        ]
      }
    ]
  },
  "details": {
    "solver_status": "OPTIMAL",
    "solve_time": "0.04초",
    "staff_count": 25,
    "shifts_identified": {
      "night_shifts": ["Night"],
      "off_shifts": ["Off"]
    }
  }
}
```

### 실패 응답 (수학적 불가능)
```json
{
  "result": "생성실패",
  "reason": "수학적 모델 해결 불가 (INFEASIBLE)",
  "status": "error",
  "details": {
    "solver_status": "INFEASIBLE",
    "solve_time": "0.05초",
    "staff_count": 5,
    "analysis": {
      "capacity_analysis": {
        "daily_slots_needed": 4,
        "total_slots_needed": 120,
        "total_staff_capacity": 116,
        "capacity_ratio": 0.967
      }
    },
    "identified_issues": [
      "용량 부족: 필요 120일 vs 가능 116일"
    ],
    "suggestions": [
      "직원 수 증가 또는 근무시간 한도 상향 조정",
      "시프트 구조 단순화 (시프트 수 줄이기)",
      "제약조건 완화 (신규간호사 야간근무 허용 등)"
    ]
  }
}
```

================================================================================
🔧 시프트 식별 시스템
================================================================================

### 3단계 시프트 식별 로직

1. **명시적 지정 (최우선)**
   ```json
   "custom_rules": {
     "night_shifts": ["Night", "야간", "N1", "N2"],
     "off_shifts": ["Off", "휴무", "R", "Free"]
   }
   ```

2. **개선된 자동 감지 (폴백)**
   - 야간 키워드: ['night', 'nocturnal', '야간', '밤', '심야'] (3글자 이상)
   - 휴무 키워드: ['off', 'rest', 'free', '휴무', '쉼', '오프'] (3글자 이상)
   - 축약형 매핑: {'n': 'night', 'o': 'off', 'r': 'rest'}

3. **직군별 기본값**
   - 간호: night_shifts=['N'], off_shifts=['O']
   - 소방: night_shifts=['D24'], off_shifts=['O']

================================================================================
🚀 성능 지표
================================================================================

### 처리 성능
- 평균 처리 시간: 0.07초
- 최고 성능: 0.04초
- 최저 성능: 0.11초

### 테스트 결과 (test_recommended.py)
- 총 테스트: 14개
- 성공률: 100% (14/14)
- 총 소요 시간: 1.0초
- 신규간호사 야간 근무 금지: 정상 작동

================================================================================
🔌 서버 설정
================================================================================

### 네트워크
- HOST: 127.0.0.1
- PORT: 6004
- 프로토콜: TCP Socket
- 인코딩: UTF-8

### 실행 명령
```bash
source shifter_env/bin/activate
python3 server_shift_scheduler_v2.py
```

================================================================================
📝 변경 이력
================================================================================

### v2.0 (2025-01-06) - 완전 개선판
- ✅ 명시적 시프트 지정 시스템 구현
- ✅ 키워드 매칭 오류 완전 해결 (Morning 문제 등)
- ✅ 프로토콜 호환성 (자동 필드 변환)
- ✅ 상세한 오류 분석 및 해결 방안 제시
- ✅ OR-Tools 제약조건 안정화
- ✅ 14/14 테스트 100% 통과
- ✅ 성능 최적화 (0.07초 평균)
- ✅ 불필요한 import/변수 제거

### v1.x (이전 버전)
- 하드코딩된 시프트 감지
- 일반적인 오류 메시지
- 프로토콜 불일치
- 불안정한 제약조건
- 0/14 테스트 통과 실패

================================================================================